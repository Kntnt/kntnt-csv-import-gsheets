<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        color: #202124;
      }
      .status-container {
        min-height: 60px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #dadce0;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
      }
      .spinner.hidden { display: none; }
      @keyframes spin { 
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); } 
      }
      #status {
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }
      .button-container {
        margin-top: 20px;
        text-align: right;
      }
      button {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: none;
      }
      button:hover { background: #1557b0; }
      button.visible { display: inline-block; }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div id="spinner" class="spinner"></div>
      <div id="status">Starting import...</div>
    </div>
    <div class="button-container">
      <button id="closeBtn">Close</button>
    </div>

    <script>
      (function() {
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');
        const closeBtn = document.getElementById('closeBtn');

        // Close button restores locale (which triggers page reload) then closes dialog
        closeBtn.addEventListener('click', function() {
          closeBtn.disabled = true;
          closeBtn.textContent = 'Closing...';
          google.script.run
            .withSuccessHandler(function() {
              google.script.host.close();
            })
            .withFailureHandler(function() {
              google.script.host.close();
            })
            .restoreLocale();
        });

        function poll() {
          google.script.run
            .withSuccessHandler(function(result) {
              if (!result || !result.message) {
                setTimeout(poll, 400);
                return;
              }

              statusEl.textContent = result.message;
              if (result.done) {
                spinnerEl.classList.add('hidden');
                closeBtn.classList.add('visible');
              } else {
                setTimeout(poll, 400);
              }
            })
            .withFailureHandler(function(err) {
              statusEl.textContent = 'Error: ' + (err.message || 'Connection lost');
              spinnerEl.classList.add('hidden');
              closeBtn.classList.add('visible');
            })
            .getImportStatus();
        }

        // Clear old status first (synchronously via callback), then start import, then poll
        google.script.run
          .withSuccessHandler(function() {
            google.script.run.importNewCSVFiles();
            setTimeout(poll, 300);
          })
          .clearImportStatus();
      })();
    </script>
  </body>
</html>
