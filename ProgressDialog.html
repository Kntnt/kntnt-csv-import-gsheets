<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; }

      body {
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        color: #202124;
      }

      .status-container {
        min-height: 60px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #dadce0;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
      }

      .spinner.hidden { display: none; }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      #status {
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }

      .warning {
        margin-top: 16px;
        padding: 12px;
        background: #fef7e0;
        border: 1px solid #f9ab00;
        border-radius: 4px;
        font-size: 12px;
        line-height: 1.4;
        color: #594300;
      }

      .button-container {
        margin-top: 20px;
        text-align: right;
      }

      #closeBtn {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: none;
      }

      #closeBtn:hover { background: #1557b0; }
      #closeBtn.visible { display: inline-block; }
      #closeBtn:disabled { background: #94c4f7; cursor: default; }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div id="spinner" class="spinner"></div>
      <div id="status">Connecting...</div>
    </div>
    <? if (originalLocale) { ?>
    <div class="warning">
      <strong>OBS!</strong> Locale har tillfälligt ändrats från <strong><?= originalLocale ?></strong> till <strong><?= currentLocale ?></strong> för att importera CSV-filer korrekt.
      Klicka på <strong>Close</strong>-knappen när importen är klar för att återställa locale automatiskt.
      Om du stänger med X måste du manuellt ändra tillbaka locale i kalkylbladets inställningar.
    </div>
    <? } ?>
    <div class="button-container">
      <button id="closeBtn">Close</button>
    </div>

    <script>
      (function () {
        'use strict';

        var statusEl = document.getElementById('status');
        var spinnerEl = document.getElementById('spinner');
        var closeBtn = document.getElementById('closeBtn');

        /**
         * Attempt to restore locale if user closes dialog via X button.
         * Note: setCloseHandler is not fully reliable, so users are warned
         * to use the Close button instead for guaranteed locale restoration.
         */
        try {
          google.script.host.setCloseHandler(function () {
            google.script.run.restoreLocale();
          });
        } catch (e) {
          // setCloseHandler may not be available in all contexts
        }

        /**
         * Close button click handler.
         * Restores the original locale before closing the dialog.
         */
        closeBtn.addEventListener('click', function () {
          closeBtn.disabled = true;
          closeBtn.textContent = 'Closing...';
          google.script.run
            .withSuccessHandler(function () { google.script.host.close(); })
            .withFailureHandler(function () { google.script.host.close(); })
            .restoreLocale();
        });

        /**
         * Polls the server for import status updates.
         * Updates the UI and schedules the next poll until import is complete.
         */
        function poll() {
          google.script.run
            .withSuccessHandler(function (result) {
              if (!result || !result.message) {
                setTimeout(poll, 400);
                return;
              }

              statusEl.textContent = result.message;

              if (result.done) {
                spinnerEl.classList.add('hidden');
                closeBtn.classList.add('visible');
              } else {
                setTimeout(poll, 400);
              }
            })
            .withFailureHandler(function (err) {
              statusEl.textContent = 'Error: ' + (err.message || 'Connection lost');
              spinnerEl.classList.add('hidden');
              closeBtn.classList.add('visible');
            })
            .getImportStatus();
        }

        // Initialize: clear any stale status, start the import, then begin polling
        google.script.run
          .withSuccessHandler(function () {
            google.script.run.importNewCSVFiles();
            setTimeout(poll, 500);
          })
          .withFailureHandler(function (err) {
            statusEl.textContent = 'Error: ' + (err.message || 'Failed to start');
            spinnerEl.classList.add('hidden');
            closeBtn.classList.add('visible');
          })
          .clearImportStatus();
      }());
    </script>
  </body>
</html>
