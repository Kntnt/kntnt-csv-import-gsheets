<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        color: #202124;
      }
      .status-container {
        min-height: 60px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #dadce0;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
      }
      .spinner.hidden { display: none; }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #status {
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }
      .button-container {
        margin-top: 20px;
        text-align: right;
      }
      #closeBtn {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: none;
      }
      #closeBtn:hover { background: #1557b0; }
      #closeBtn.visible { display: inline-block; }
      #closeBtn:disabled { background: #94c4f7; cursor: default; }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div id="spinner" class="spinner"></div>
      <div id="status">Connecting...</div>
    </div>
    <div class="button-container">
      <button id="closeBtn">Close</button>
    </div>

    <script>
      (function() {
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');
        const closeBtn = document.getElementById('closeBtn');

        // Backup: restore locale if user closes via X icon
        try {
          google.script.host.setCloseHandler(function() {
            google.script.run.restoreLocale();
          });
        } catch (e) {
          // Ignore
        }

        // Close button handler
        closeBtn.addEventListener('click', function() {
          closeBtn.disabled = true;
          closeBtn.textContent = 'Closing...';
          google.script.run
            .withSuccessHandler(function() { google.script.host.close(); })
            .withFailureHandler(function() { google.script.host.close(); })
            .restoreLocale();
        });

        function poll() {
          google.script.run
            .withSuccessHandler(function(result) {
              if (!result || !result.message) {
                setTimeout(poll, 400);
                return;
              }

              statusEl.textContent = result.message;
              if (result.done) {
                spinnerEl.classList.add('hidden');
                closeBtn.classList.add('visible');
              } else {
                setTimeout(poll, 400);
              }
            })
            .withFailureHandler(function(err) {
              statusEl.textContent = 'Error: ' + (err.message || 'Connection lost');
              spinnerEl.classList.add('hidden');
              closeBtn.classList.add('visible');
            })
            .getImportStatus();
        }

        // Clear old status, start import, then poll
        google.script.run
          .withSuccessHandler(function() {
            google.script.run.importNewCSVFiles();
            setTimeout(poll, 500);
          })
          .withFailureHandler(function(err) {
            statusEl.textContent = 'Error: ' + (err.message || 'Failed to start');
            spinnerEl.classList.add('hidden');
            closeBtn.classList.add('visible');
          })
          .clearImportStatus();
      })();
    </script>
  </body>
</html>
