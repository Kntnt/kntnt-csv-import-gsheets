<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Google Sans', Roboto, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        color: #202124;
      }
      .status-container {
        min-height: 60px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #dadce0;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
      }
      .spinner.hidden { display: none; }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #status {
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div id="spinner" class="spinner"></div>
      <div id="status">Loading...</div>
    </div>

    <script>
      (function() {
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');

        // When dialog closes (via X icon), restore the original locale
        google.script.host.setCloseHandler(function() {
          google.script.run.restoreLocale();
        });

        function poll() {
          google.script.run
            .withSuccessHandler(function(result) {
              if (!result || !result.message) {
                setTimeout(poll, 400);
                return;
              }

              statusEl.textContent = result.message;
              if (result.done) {
                spinnerEl.classList.add('hidden');
              } else {
                setTimeout(poll, 400);
              }
            })
            .withFailureHandler(function(err) {
              statusEl.textContent = 'Poll error: ' + (err.message || 'Connection lost');
              spinnerEl.classList.add('hidden');
            })
            .getImportStatus();
        }

        // Confirm JavaScript is running
        statusEl.textContent = 'JavaScript running, calling server...';
        google.script.run
          .withSuccessHandler(function() {
            // Step 2: Start import
            statusEl.textContent = 'Starting import...';
            google.script.run
              .withFailureHandler(function(err) {
                statusEl.textContent = 'Import error: ' + (err.message || 'Unknown error');
                spinnerEl.classList.add('hidden');
              })
              .importNewCSVFiles();
            // Step 3: Start polling
            setTimeout(function() {
              statusEl.textContent = 'Waiting for status...';
              poll();
            }, 500);
          })
          .withFailureHandler(function(err) {
            statusEl.textContent = 'Clear error: ' + (err.message || 'Unknown error');
            spinnerEl.classList.add('hidden');
          })
          .clearImportStatus();
      })();
    </script>
  </body>
</html>
